name: Sync Feature Flags to Flipt

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'flipt/features.yml'
  pull_request:
    paths:
      - 'flipt/features.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Flag Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          # Install yq for YAML validation
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Validate YAML
          yq eval 'flipt/features.yml' > /dev/null
          echo "âœ… YAML syntax is valid"

      - name: Check required fields
        run: |
          echo "ğŸ” Checking flag configuration..."
          yq eval '.flags[] | .key' flipt/features.yml
          echo "âœ… Configuration validated"

  sync-to-flipt-dev:
    name: Sync to Flipt (Development)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Import flags to Flipt
        run: |
          echo "ğŸš€ Syncing flags to Flipt Development..."
          
          # Using Flipt CLI (if installed) or direct API calls
          curl -X POST "${{ secrets.FLIPT_DEV_URL }}/api/v1/namespaces/default/flags/import" \
            -H "Authorization: Bearer ${{ secrets.FLIPT_DEV_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @flipt/features.yml || echo "âš ï¸ Sync failed - check Flipt connection"

      - name: Verify sync
        run: |
          echo "âœ… Flags synced to Development environment"

  sync-to-flipt-prod:
    name: Sync to Flipt (Production)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create backup
        run: |
          echo "ğŸ“¦ Creating backup of current flags..."
          curl "${{ secrets.FLIPT_PROD_URL }}/api/v1/namespaces/default/flags" \
            -H "Authorization: Bearer ${{ secrets.FLIPT_PROD_TOKEN }}" \
            -o backup-$(date +%Y%m%d-%H%M%S).json || true

      - name: Import flags to Flipt
        run: |
          echo "ğŸš€ Syncing flags to Flipt Production..."
          
          curl -X POST "${{ secrets.FLIPT_PROD_URL }}/api/v1/namespaces/default/flags/import" \
            -H "Authorization: Bearer ${{ secrets.FLIPT_PROD_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @flipt/features.yml || echo "âš ï¸ Sync failed - check Flipt connection"

      - name: Notify team
        if: success()
        run: |
          echo "âœ… Feature flags deployed to Production"
          echo "ğŸ“Š Flags updated at $(date)"

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract flag changes
        id: changes
        run: |
          echo "flags<<EOF" >> $GITHUB_OUTPUT
          yq eval '.flags[] | "- **" + .key + "**: " + .description' flipt/features.yml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš© Feature Flag Changes
              
              This PR modifies feature flag configuration:
              
              ${{ steps.changes.outputs.flags }}
              
              ### Next Steps
              - âœ… Configuration validated
              - ğŸ” Review the changes carefully
              - ğŸš€ Merge to \`develop\` to deploy to Development
              - ğŸš€ Merge to \`main\` to deploy to Production
              `
            })
