name: Sync Feature Flags to Flipt

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'flipt/features.yml'
  pull_request:
    paths:
      - 'flipt/features.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Flag Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate YAML syntax
        run: |
          yq eval 'flipt/features.yml' > /dev/null
          echo "âœ… YAML syntax is valid"

      - name: Extract and display flags
        run: |
          echo "ğŸ“‹ Flags in configuration:"
          yq eval '.flags[] | "  - " + .key + ": " + .name' flipt/features.yml
          echo ""
          echo "âœ… Configuration validated"

  sync-to-flipt-dev:
    name: Sync to Flipt (Development)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq and jq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          apt-get update && apt-get install -y jq

      - name: Create flags via API
        run: |
          FLIPT_URL="http://localhost:8080"
          echo "ğŸš€ Syncing flags to Flipt Development ($FLIPT_URL)..."
          
          # Extract flags and create them
          yq eval '.flags[]' flipt/features.yml | while IFS= read -r flag_data; do
            flag_json=$(yq eval -o=json '.' <<< "$flag_data")
            key=$(echo "$flag_json" | jq -r '.key')
            
            echo "Creating flag: $key"
            curl -s -X POST "$FLIPT_URL/api/v1/namespaces/default/flags" \
              -H "Content-Type: application/json" \
              -d "$flag_json" \
              -w "\nStatus: %{http_code}\n" || echo "âš ï¸ Failed to create $key"
          done
          
          echo "âœ… Flags synced to Development environment"

      - name: Create segments via API
        run: |
          FLIPT_URL="http://localhost:8080"
          echo "ğŸ“ Syncing segments to Flipt Development..."
          
          # Extract segments and create them
          yq eval '.segments[]' flipt/features.yml | while IFS= read -r segment_data; do
            segment_json=$(yq eval -o=json '.' <<< "$segment_data")
            key=$(echo "$segment_json" | jq -r '.key')
            
            echo "Creating segment: $key"
            curl -s -X POST "$FLIPT_URL/api/v1/namespaces/default/segments" \
              -H "Content-Type: application/json" \
              -d "$segment_json" \
              -w "\nStatus: %{http_code}\n" || echo "âš ï¸ Failed to create segment $key"
          done

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Extract flag changes
        id: changes
        run: |
          echo "flags<<EOF" >> $GITHUB_OUTPUT
          yq eval '.flags[] | "- **" + .key + "**: " + .name' flipt/features.yml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš© Feature Flag Changes
              
              This PR modifies feature flag configuration:
              
              ${{ steps.changes.outputs.flags }}
              
              ### Configuration
              All flags include optional rules and metadata for advanced targeting.
              
              ### Next Steps
              - âœ… Configuration validated by workflow
              - ğŸ” Review the changes carefully
              - ğŸš€ Merge to \`main\` to deploy to both Dev and Production
              
              **Note**: Segments and rules will be synced automatically on merge.
              `
            })
